# 非雪季与雪季票务系统API对接详细文档

## 文档说明
本文档详细描述非雪季后台系统与雪季票务系统之间的API对接细节，包括请求格式、响应格式、错误处理等。

---

## 一、认证与授权

### 1.1 请求头规范

#### 通用请求头

```http
Content-Type: application/json
X-Terminal: CUSTOMER_WX_MINIAPP  // 终端类型标识
```

#### 雪季系统对接请求头

```http
authorization: Bearer {token}                      // 雪季系统访问令牌
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302    // 租户ID（固定值）
SiteId: {siteId}                                   // 站点ID
```

#### 微信登录请求头

```http
X-Wx-Login-Token: {token}  // 微信登录临时token
```

### 1.2 终端类型枚举

| 终端类型 | 代码 | 说明 |
|---------|------|------|
| 客户端小程序 | CUSTOMER_WX_MINIAPP | 普通用户使用的微信小程序 |
| 核销端小程序 | WORKER_WX_MINIAPP | 工作人员核销使用的小程序 |
| 后台管理系统 | OPERATION_BACKGROUND_PC | PC端后台管理系统 |

### 1.3 响应格式规范

#### 成功响应

```json
{
  "code": "0000",
  "msg": "成功",
  "data": {
    // 业务数据
  }
}
```

#### 错误响应

```json
{
  "code": "9001",
  "msg": "错误描述",
  "data": null
}
```

#### 常用响应码

| 响应码 | 说明 |
|-------|------|
| 0000 | 成功 |
| 1000 | 未登录 |
| 1009 | 非法终端调用 |
| 9000 | 参数错误 |
| 9001 | 业务错误 |
| 9100 | 业务提示（如重复提交） |
| 9999 | 系统异常 |

---

## 二、用户登录与认证接口

### 2.1 微信小程序登录

#### 接口信息

```
GET /api/login/miniapp
```

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| jscode | String | 是 | 微信临时登录凭证code |

#### 请求头

```http
X-Terminal: CUSTOMER_WX_MINIAPP
```

#### 请求示例

```http
GET /api/login/miniapp?jscode=081xYz000dVTkr1234567890 HTTP/1.1
Host: jh.bjstarfish.com
X-Terminal: CUSTOMER_WX_MINIAPP
```

#### 响应示例

```json
{
  "code": "0000",
  "msg": "成功",
  "data": null
}
```

#### 响应头

```http
X-Wx-Login-Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### 业务流程

1. 前端调用 `wx.login()` 获取 `code`
2. 将 `code` 发送到后端
3. 后端调用微信接口获取 `openid` 和 `session_key`
4. 保存到 `xs_wx_user` 表
5. 生成 `X-Wx-Login-Token` 返回给前端
6. 前端保存 token 用于后续手机号授权

---

### 2.2 手机号授权登录

#### 接口信息

```
GET /api/login/auth/phone
```

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| code | String | 是 | 微信手机号授权code |

#### 请求头

```http
X-Terminal: CUSTOMER_WX_MINIAPP
X-Wx-Login-Token: {微信登录token}
authorization: {雪季系统token}  // 可选，如果有则同步雪季用户信息
SiteId: {雪季站点ID}            // 可选
```

#### 请求示例

**场景1：仅非雪季系统登录**

```http
GET /api/login/auth/phone?code=abc123def456 HTTP/1.1
Host: jh.bjstarfish.com
X-Terminal: CUSTOMER_WX_MINIAPP
X-Wx-Login-Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

**场景2：从雪季系统跳转（带雪季token）**

```http
GET /api/login/auth/phone?code=abc123def456 HTTP/1.1
Host: jh.bjstarfish.com
X-Terminal: CUSTOMER_WX_MINIAPP
X-Wx-Login-Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
authorization: Bearer snow_system_token_xxx
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302
SiteId: site123
```

#### 响应示例

```json
{
  "code": "0000",
  "msg": "成功",
  "data": null
}
```

#### 业务流程

1. 前端调用微信手机号授权组件获取 `code`
2. 携带 `X-Wx-Login-Token` 和 `code` 请求后端
3. 后端解密获取手机号
4. 如果有雪季系统 token，调用雪季API获取用户信息
5. 创建或更新 `xs_login_user`（如果有雪季信息，保存 `bjstarfish_uid`）
6. 绑定微信用户和登录用户关系（`xs_wx_bind_login_user`）
7. 创建Session
8. 返回登录成功

#### 数据库操作

```sql
-- 1. 查询或创建登录用户
INSERT INTO xs_login_user (
  bjstarfish_uid, phone_number, name, nick_name, 
  head_path, user_type, status
) VALUES (
  '雪季用户ID', '13800138000', '张三', '昵称',
  '头像URL', 'outsider', 1
) ON DUPLICATE KEY UPDATE 
  bjstarfish_uid = VALUES(bjstarfish_uid),
  name = VALUES(name),
  nick_name = VALUES(nick_name),
  head_path = VALUES(head_path);

-- 2. 绑定微信用户
INSERT INTO xs_wx_bind_login_user (
  appid, wx_user_id, login_user_id
) VALUES (
  'wx115c6fd43670160d', 1, 123
) ON DUPLICATE KEY UPDATE 
  login_user_id = VALUES(login_user_id);
```

---

### 2.3 Token登录（跨系统）

#### 接口信息

```
GET /api/login/token
```

#### 请求参数

无

#### 请求头

```http
X-Terminal: CUSTOMER_WX_MINIAPP
authorization: Bearer {雪季系统token}
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302
SiteId: {雪季站点ID}
```

#### 请求示例

```http
GET /api/login/token HTTP/1.1
Host: jh.bjstarfish.com
X-Terminal: CUSTOMER_WX_MINIAPP
authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302
SiteId: site123
```

#### 响应示例

```json
{
  "code": "0000",
  "msg": "成功",
  "data": {
    "userId": 123,
    "name": "张三",
    "phoneNumber": "13800138000",
    "userType": "outsider"
  }
}
```

#### 业务流程

1. 从雪季系统跳转时携带雪季 token
2. 调用雪季API验证token并获取用户信息
3. 根据 `bjstarfish_uid` 查找本地用户
4. 如果用户不存在，自动创建并关联
5. 创建本地Session
6. 返回登录成功及用户信息

---

### 2.4 账号密码登录（后台管理）

#### 接口信息

```
POST /api/login/password
```

#### 请求参数

```json
{
  "phoneNumber": "admin",
  "password": "123456"
}
```

#### 请求头

```http
X-Terminal: OPERATION_BACKGROUND_PC
Content-Type: application/json
```

#### 请求示例

```http
POST /api/login/password HTTP/1.1
Host: jh.bjstarfish.com
X-Terminal: OPERATION_BACKGROUND_PC
Content-Type: application/json

{
  "phoneNumber": "admin",
  "password": "123456"
}
```

#### 响应示例

```json
{
  "code": "0000",
  "msg": "成功",
  "data": null
}
```

#### 业务流程

1. 接收手机号和密码
2. 查询 `xs_login_user` 表
3. 验证密码（MD5加密比对）
4. 验证用户状态
5. 创建Session
6. 返回登录成功

#### 密码加密

```java
// 密码加密方式：MD5
String encryptedPassword = Md5Utils.md5(password);
```

---

### 2.5 退出登录

#### 接口信息

```
GET /api/logout
```

#### 请求参数

无

#### 请求头

```http
Cookie: SESSION={sessionId}
```

#### 请求示例

```http
GET /api/logout HTTP/1.1
Host: jh.bjstarfish.com
Cookie: SESSION=MTIzNDU2Nzg5MA==
```

#### 响应示例

```json
{
  "code": "0000",
  "msg": "成功",
  "data": null
}
```

#### 业务流程

1. 从Session中获取用户信息
2. 清除Redis中的Session数据
3. 清除Cookie中的SESSION
4. 返回成功

---

## 三、雪季系统API对接

### 3.1 获取访问令牌

#### 接口信息

```
POST {雪季系统域名}/connect/token
```

#### 请求参数

```
grant_type=wx-mp
client_id=wechatmini
client_secret=admin
access_token=get
```

#### 请求头

```http
Content-Type: application/x-www-form-urlencoded
```

#### 请求示例

```http
POST /connect/token HTTP/1.1
Host: xs.bjstarfish.com
Content-Type: application/x-www-form-urlencoded

grant_type=wx-mp&client_id=wechatmini&client_secret=admin&access_token=get
```

#### 响应示例

```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "expiresIn": 3600,
  "tokenType": "Bearer"
}
```

#### Java实现

```java
public String getAccessTokenFromOther(WxMaOtherProperties maOtherProperties) {
    FormBody formBody = new FormBody.Builder()
            .add("grant_type", maOtherProperties.getGrantType())
            .add("client_id", maOtherProperties.getClientId())
            .add("client_secret", maOtherProperties.getClientSecret())
            .add("access_token", "get")
            .build();
    
    Request request = new Request.Builder()
            .url(otherDomain + "/connect/token")
            .post(formBody)
            .build();
    
    Response execute = okHttpClient.newCall(request).execute();
    if (execute.isSuccessful()) {
        String result = execute.body().string();
        JsonNode jsonObj = JSONObject.parseObject(result);
        return jsonObj.findValue("accessToken").asText();
    }
    throw new WxRuntimeException("获取 access_token 失败");
}
```

---

### 3.2 获取用户信息

#### 接口信息

```
POST {雪季系统域名}/mapi/miniprogram/users/getUser
```

#### 请求参数

无

#### 请求头

```http
authorization: Bearer {token}
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302
SiteId: {siteId}
Content-Type: application/x-www-form-urlencoded
```

#### 请求示例

```http
POST /mapi/miniprogram/users/getUser HTTP/1.1
Host: xs.bjstarfish.com
authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302
SiteId: site123
```

#### 响应示例

```json
{
  "id": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "name": "张三",
  "phoneNumber": "13800138000",
  "extraProperties": {
    "wx-openid": "oABC123DEF456GHI789",
    "wx-unionid": "oXYZ987UVW654TSR321",
    "NickName": "昵称",
    "avatarUrl": "https://example.com/avatar.jpg"
  }
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 雪季系统用户唯一标识（UUID） |
| name | String | 用户姓名 |
| phoneNumber | String | 手机号 |
| extraProperties.wx-openid | String | 微信OpenID |
| extraProperties.wx-unionid | String | 微信UnionID |
| extraProperties.NickName | String | 微信昵称 |
| extraProperties.avatarUrl | String | 微信头像URL |

#### Java实现

```java
public ThirdUserInfo getThirdUserInfo(HttpServletRequest request) throws IOException {
    FormBody formBody = new FormBody.Builder().build();
    
    Request.Builder requestBuilder = new Request.Builder()
            .post(formBody)
            .addHeader("authorization", request.getHeader("authorization"))
            .addHeader("__tenant", "ae9c54cc-94e0-5552-ef06-3a044ab7a302")
            .addHeader("SiteId", request.getHeader("siteid"))
            .url(otherDomain + "/mapi/miniprogram/users/getUser");

    Response execute = okHttpClient.newCall(requestBuilder.build()).execute();

    if (execute.isSuccessful()) {
        String result = execute.body().string();
        JsonNode jsonNode = JSONObject.parseObject(result);

        String id = jsonNode.has("id") ? jsonNode.get("id").asText(null) : null;
        String name = jsonNode.has("name") ? jsonNode.get("name").asText(null) : null;
        String phoneNumber = jsonNode.has("phoneNumber") ? 
            jsonNode.get("phoneNumber").asText(null) : null;

        JsonNode extraProperties = jsonNode.get("extraProperties");
        String wxOpenid = extraProperties != null && extraProperties.has("wx-openid") ? 
            extraProperties.get("wx-openid").asText(null) : null;
        String wxUnionid = extraProperties != null && extraProperties.has("wx-unionid") ? 
            extraProperties.get("wx-unionid").asText(null) : null;
        String nickName = extraProperties != null && extraProperties.has("NickName") ? 
            extraProperties.get("NickName").asText(null) : null;
        String avatarUrl = extraProperties != null && extraProperties.has("avatarUrl") ? 
            extraProperties.get("avatarUrl").asText(null) : null;

        return new ThirdUserInfo()
                .setId(id)
                .setName(name)
                .setPhoneNumber(phoneNumber)
                .setWxOpenid(wxOpenid)
                .setWxUnionid(wxUnionid)
                .setNickName(nickName)
                .setAvatarUrl(avatarUrl);
    }
    return null;
}
```

---

### 3.3 获取票务信息

#### 接口信息

```
POST {雪季系统域名}/mapi/miniprogram/Ticket/GetTicket
```

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| orderTicketId | String | 是 | 票务ID |

#### 请求头

```http
authorization: Bearer {token}
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302
SiteId: {siteId}
Content-Type: application/x-www-form-urlencoded
```

#### 请求示例

```http
POST /mapi/miniprogram/Ticket/GetTicket?orderTicketId=ticket123 HTTP/1.1
Host: xs.bjstarfish.com
authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302
SiteId: site123
```

#### 响应示例

```json
{
  "ticketId": "SNOW2024001",
  "orderId": "order123456",
  "code": "202401010001",
  "status": 60,
  "productName": "雪票+餐饮套票",
  "price": 29800
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| ticketId | String | 票务编码（套票编码） |
| orderId | String | 订单ID |
| code | String | 票号 |
| status | Integer | 票务状态（60和130时可以核销） |
| productName | String | 产品名称 |
| price | Integer | 价格（分） |

#### Java实现

```java
public ThirdTicketInfo getThirdTicketInfo(HttpServletRequest request, 
                                          String orderTicketId) throws IOException {
    FormBody formBody = new FormBody.Builder().build();
    
    Request.Builder requestBuilder = new Request.Builder()
            .post(formBody)
            .addHeader("authorization", request.getHeader("authorization"))
            .addHeader("__tenant", "ae9c54cc-94e0-5552-ef06-3a044ab7a302")
            .addHeader("SiteId", request.getHeader("siteid"))
            .url(otherDomain + String.format(
                "/mapi/miniprogram/Ticket/GetTicket?orderTicketId=%s", 
                orderTicketId));

    Response execute = okHttpClient.newCall(requestBuilder.build()).execute();

    if (execute.isSuccessful()) {
        String result = execute.body().string();
        JsonNode jsonNode = JSONObject.parseObject(result);

        String ticketId = jsonNode.has("ticketId") ? 
            jsonNode.get("ticketId").asText(null) : null;
        String orderId = jsonNode.has("orderId") ? 
            jsonNode.get("orderId").asText(null) : null;
        String code = jsonNode.has("code") ? 
            jsonNode.get("code").asText(null) : null;
        Integer status = jsonNode.has("status") ? 
            jsonNode.get("status").asInt() : null;

        return new ThirdTicketInfo()
                .setTicketId(ticketId)
                .setOrderId(orderId)
                .setCode(code)
                .setStatus(status)
                .setTicketInfoJsonStr(result);
    }
    return null;
}
```

---

### 3.4 获取订单信息

#### 接口信息

```
POST {雪季系统域名}/mapi/miniprogram/Order/{orderId}
```

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| orderId | String | 是 | 订单ID（路径参数） |

#### 请求头

```http
authorization: Bearer {token}
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302
SiteId: {siteId}
Content-Type: application/x-www-form-urlencoded
```

#### 请求示例

```http
POST /mapi/miniprogram/Order/order123456 HTTP/1.1
Host: xs.bjstarfish.com
authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302
SiteId: site123
```

#### 响应示例

```json
{
  "id": "order123456",
  "orderNumber": "ORD20240101001",
  "totalPrice": 29800,
  "status": 2,
  "extraProperties": {
    "AvailableStartTime": "2024-01-01 00:00:00",
    "AvailableEndTime": "2024-12-31 23:59:59"
  }
}
```

#### 响应字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| id | String | 订单ID |
| orderNumber | String | 订单编号 |
| totalPrice | Integer | 总价（分） |
| status | Integer | 订单状态 |
| extraProperties.AvailableStartTime | String | 有效期开始时间 |
| extraProperties.AvailableEndTime | String | 有效期结束时间 |

#### Java实现

```java
public String getOrderInfo(HttpServletRequest request, 
                          String orderId) throws IOException {
    FormBody formBody = new FormBody.Builder().build();
    
    Request.Builder requestBuilder = new Request.Builder()
            .post(formBody)
            .addHeader("authorization", request.getHeader("authorization"))
            .addHeader("__tenant", "ae9c54cc-94e0-5552-ef06-3a044ab7a302")
            .addHeader("SiteId", request.getHeader("siteid"))
            .url(otherDomain + String.format("/mapi/miniprogram/Order/%s", orderId));

    Response execute = okHttpClient.newCall(requestBuilder.build()).execute();

    if (execute.isSuccessful()) {
        return execute.body().string();
    }
    return null;
}
```

---

## 四、套票管理接口

### 4.1 查询套票信息

#### 接口信息

```
GET /api/vma/packageTicket/info
```

#### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|-------|------|------|------|
| ticketId | String | 是 | 票务编码（套票编码） |
| snowTicketId | String | 是 | 雪票系统票号 |

#### 请求头

```http
authorization: Bearer {雪季系统token}
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302
SiteId: {siteId}
Cookie: SESSION={sessionId}
```

#### 请求示例

```http
GET /api/vma/packageTicket/info?ticketId=SNOW2024001&snowTicketId=ticket123 HTTP/1.1
Host: jh.bjstarfish.com
authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302
SiteId: site123
Cookie: SESSION=MTIzNDU2Nzg5MA==
```

#### 响应示例

**场景1：是套票**

```json
{
  "code": "0000",
  "msg": "成功",
  "data": {
    "packageFlag": "YES",
    "packageTicketInfo": {
      "id": 1,
      "name": "雪票+餐饮套票",
      "type": 1,
      "snowTicketCode": "SNOW2024001",
      "cateringName": "西餐厅套餐",
      "cateringPrice": 8800,
      "cateringProduct": "[{\"name\":\"牛排\",\"count\":1},{\"name\":\"红酒\",\"count\":1}]",
      "status": 1
    },
    "snowTicketRecord": {
      "id": 1,
      "snowTicketNum": "202401010001",
      "snowTicketId": "ticket123",
      "userId": 123,
      "name": "张三",
      "phoneNumber": "13800138000",
      "verificationStatus": 0,
      "verificationTime": null,
      "workerUserId": null,
      "startDate": "2024-01-01 00:00:00",
      "endDate": "2024-12-31 23:59:59",
      "createTime": "2024-01-01 10:00:00",
      "updateTime": "2024-01-01 10:00:00"
    }
  }
}
```

**场景2：非套票**

```json
{
  "code": "0000",
  "msg": "成功",
  "data": {
    "packageFlag": "NO"
  }
}
```

#### 业务流程

1. 接收 `ticketId` 和 `snowTicketId`
2. 根据 `ticketId` 查询 `xs_package_ticket_info` 表
3. 如果不是套票，返回 `packageFlag=NO`
4. 如果是套票，查询 `xs_package_ticket_snow_record` 表
5. 如果记录不存在，调用雪季API获取票务和订单信息，创建记录
6. 如果记录存在，调用雪季API更新最新状态
7. 返回套票信息和用户套票记录

---

### 4.2 套票核销

#### 接口信息

```
POST /api/vma/packageTicket/verification
```

#### 请求参数

```json
{
  "userId": 123,
  "snowTicketId": "ticket123"
}
```

#### 请求头

```http
X-Terminal: WORKER_WX_MINIAPP
Content-Type: application/json
Cookie: SESSION={sessionId}
```

#### 请求示例

```http
POST /api/vma/packageTicket/verification HTTP/1.1
Host: jh.bjstarfish.com
X-Terminal: WORKER_WX_MINIAPP
Content-Type: application/json
Cookie: SESSION=MTIzNDU2Nzg5MA==

{
  "userId": 123,
  "snowTicketId": "ticket123"
}
```

#### 响应示例

**成功**

```json
{
  "code": "0000",
  "msg": "核销成功",
  "data": {
    "verificationTime": "2024-01-15 10:30:00",
    "workerUserId": 5,
    "workerName": "李四"
  }
}
```

**失败**

```json
{
  "code": "9001",
  "msg": "套票已核销，请勿重复使用",
  "data": null
}
```

#### 错误码说明

| 错误码 | 错误信息 |
|-------|---------|
| 9001 | 无效核销二维码 |
| 9001 | 套票已核销，请勿重复使用 |
| 9001 | 套票过期，不能核销 |
| 9001 | 套票未到使用时间，不能核销 |

#### 业务流程

1. 接收 `userId` 和 `snowTicketId`
2. 查询 `xs_package_ticket_snow_record` 表
3. 验证套票是否存在
4. 验证套票是否已核销
5. 验证套票有效期
6. 更新核销状态、核销人、核销时间
7. 返回核销成功信息

#### 数据库操作

```sql
UPDATE xs_package_ticket_snow_record 
SET 
  verification_status = 1,
  worker_user_id = 5,
  verification_time = NOW(),
  update_time = NOW()
WHERE 
  user_id = 123 
  AND snow_ticket_id = 'ticket123'
  AND verification_status = 0;
```

---

### 4.3 套票核销记录查询

#### 接口信息

```
POST /api/vma/packageTicket/record/page
```

#### 请求参数

```json
{
  "pageNum": 1,
  "pageSize": 10,
  "name": "张三",
  "phoneNumber": "138",
  "verificationStatus": 1,
  "startTime": "2024-01-01 00:00:00",
  "endTime": "2024-01-31 23:59:59"
}
```

#### 请求头

```http
X-Terminal: WORKER_WX_MINIAPP
Content-Type: application/json
Cookie: SESSION={sessionId}
```

#### 请求示例

```http
POST /api/vma/packageTicket/record/page HTTP/1.1
Host: jh.bjstarfish.com
X-Terminal: WORKER_WX_MINIAPP
Content-Type: application/json
Cookie: SESSION=MTIzNDU2Nzg5MA==

{
  "pageNum": 1,
  "pageSize": 10,
  "verificationStatus": 1
}
```

#### 响应示例

```json
{
  "code": "0000",
  "msg": "成功",
  "data": {
    "total": 100,
    "pageNum": 1,
    "pageSize": 10,
    "list": [
      {
        "id": 1,
        "snowTicketNum": "202401010001",
        "snowTicketId": "ticket123",
        "userId": 123,
        "name": "张三",
        "phoneNumber": "13800138000",
        "packageInfo": "{\"name\":\"雪票+餐饮套票\"}",
        "verificationStatus": 1,
        "workerUserId": 5,
        "workerName": "李四",
        "verificationTime": "2024-01-15 10:30:00",
        "createTime": "2024-01-01 10:00:00"
      }
    ]
  }
}
```

---

## 五、用户信息接口

### 5.1 保存用户信息

#### 接口信息

```
POST /api/wxma/user/save
```

#### 请求参数

```json
{
  "name": "张三",
  "nickName": "昵称",
  "headPath": "https://example.com/avatar.jpg"
}
```

#### 请求头

```http
Content-Type: application/json
Cookie: SESSION={sessionId}
```

#### 请求示例

```http
POST /api/wxma/user/save HTTP/1.1
Host: jh.bjstarfish.com
Content-Type: application/json
Cookie: SESSION=MTIzNDU2Nzg5MA==

{
  "name": "张三",
  "nickName": "昵称",
  "headPath": "https://example.com/avatar.jpg"
}
```

#### 响应示例

```json
{
  "code": "0000",
  "msg": "成功",
  "data": null
}
```

#### 业务流程

1. 从Session中获取用户ID
2. 更新 `xs_login_user` 表的用户信息
3. 返回成功

---

### 5.2 查询用户信息

#### 接口信息

```
GET /api/wxma/user/info
```

#### 请求参数

无

#### 请求头

```http
Cookie: SESSION={sessionId}
```

#### 请求示例

```http
GET /api/wxma/user/info HTTP/1.1
Host: jh.bjstarfish.com
Cookie: SESSION=MTIzNDU2Nzg5MA==
```

#### 响应示例

```json
{
  "code": "0000",
  "msg": "成功",
  "data": {
    "id": 123,
    "phoneNumber": "13800138000",
    "name": "张三",
    "nickName": "昵称",
    "headPath": "https://example.com/avatar.jpg",
    "userType": "outsider",
    "score": 1000,
    "status": 1,
    "lastLoginTime": "2024-01-15 10:00:00"
  }
}
```

---

## 六、错误处理

### 6.1 常见错误场景

#### 场景1：未登录

**错误码**: 1000

**错误信息**: "未登录"

**解决方案**: 引导用户重新登录

#### 场景2：Token过期

**错误码**: 1000

**错误信息**: "登录已过期"

**解决方案**: 清除本地Session，引导用户重新登录

#### 场景3：参数错误

**错误码**: 9000

**错误信息**: "参数错误"

**解决方案**: 检查请求参数是否完整和正确

#### 场景4：业务错误

**错误码**: 9001

**错误信息**: 具体业务错误描述

**解决方案**: 根据错误信息提示用户

#### 场景5：系统异常

**错误码**: 9999

**错误信息**: "系统异常"

**解决方案**: 联系技术支持

### 6.2 错误日志

所有API调用错误都会记录到日志文件：

```
/application/xishanclub/backend/logs/xishanclub-main.log
```

日志格式：

```
2024-01-15 10:30:00.123 ERROR [http-nio-18080-exec-1] o.x.c.m.t.BjstartfishApiService - 获取雪票信息异常, snowTicketId:ticket123
java.io.IOException: Connection timeout
    at ...
```

---

## 七、测试用例

### 7.1 登录流程测试

#### 测试用例1：微信小程序登录

```bash
# 步骤1：微信小程序登录
curl -X GET "http://localhost:18080/api/login/miniapp?jscode=081xYz000dVTkr1234567890" \
  -H "X-Terminal: CUSTOMER_WX_MINIAPP"

# 预期响应：
# X-Wx-Login-Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
# {"code":"0000","msg":"成功","data":null}

# 步骤2：手机号授权登录
curl -X GET "http://localhost:18080/api/login/auth/phone?code=abc123def456" \
  -H "X-Terminal: CUSTOMER_WX_MINIAPP" \
  -H "X-Wx-Login-Token: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# 预期响应：
# Set-Cookie: SESSION=MTIzNDU2Nzg5MA==
# {"code":"0000","msg":"成功","data":null}
```

#### 测试用例2：账号密码登录

```bash
curl -X POST "http://localhost:18080/api/login/password" \
  -H "X-Terminal: OPERATION_BACKGROUND_PC" \
  -H "Content-Type: application/json" \
  -d '{
    "phoneNumber": "admin",
    "password": "123456"
  }'

# 预期响应：
# Set-Cookie: SESSION=MTIzNDU2Nzg5MA==
# {"code":"0000","msg":"成功","data":null}
```

### 7.2 套票查询测试

```bash
curl -X GET "http://localhost:18080/api/vma/packageTicket/info?ticketId=SNOW2024001&snowTicketId=ticket123" \
  -H "authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "__tenant: ae9c54cc-94e0-5552-ef06-3a044ab7a302" \
  -H "SiteId: site123" \
  -H "Cookie: SESSION=MTIzNDU2Nzg5MA=="

# 预期响应：
# {"code":"0000","msg":"成功","data":{"packageFlag":"YES",...}}
```

### 7.3 套票核销测试

```bash
curl -X POST "http://localhost:18080/api/vma/packageTicket/verification" \
  -H "X-Terminal: WORKER_WX_MINIAPP" \
  -H "Content-Type: application/json" \
  -H "Cookie: SESSION=MTIzNDU2Nzg5MA==" \
  -d '{
    "userId": 123,
    "snowTicketId": "ticket123"
  }'

# 预期响应：
# {"code":"0000","msg":"核销成功","data":{"verificationTime":"2024-01-15 10:30:00"}}
```

---

## 八、附录

### 8.1 配置参数说明

| 参数名 | 说明 | 示例值 |
|-------|------|--------|
| other.system.domain | 雪季系统域名 | https://xs.bjstarfish.com |
| wx.other.grant-type | OAuth授权类型 | wx-mp |
| wx.other.client-id | 客户端ID | wechatmini |
| wx.other.client-secret | 客户端密钥 | admin |
| __tenant | 租户ID（固定值） | ae9c54cc-94e0-5552-ef06-3a044ab7a302 |

### 8.2 数据字典

#### 用户类型

| 值 | 说明 |
|----|------|
| outsider | 外部用户 |
| insider | 内部员工 |

#### 用户状态

| 值 | 说明 |
|----|------|
| 0 | 禁用 |
| 1 | 正常 |

#### 核销状态

| 值 | 说明 |
|----|------|
| 0 | 未核销 |
| 1 | 已核销 |

#### 票务状态

| 值 | 说明 |
|----|------|
| 60 | 可核销 |
| 130 | 可核销 |

---

**文档结束**

